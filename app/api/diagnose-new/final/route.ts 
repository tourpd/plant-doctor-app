import { NextResponse } from "next/server";
import OpenAI from "openai";

export async function POST(req: Request) {
  try {
    if (!process.env.OPENAI_API_KEY) {
      return NextResponse.json(
        { ok: false, error: "OPENAI_API_KEY ì—†ìŒ" },
        { status: 500 }
      );
    }

    const form = await req.formData();
    const image = form.get("image") as File | null;

    if (!image) {
      return NextResponse.json(
        { ok: false, error: "ì´ë¯¸ì§€ ì—†ìŒ" },
        { status: 400 }
      );
    }

    // ì´ë¯¸ì§€ â†’ base64
    const buffer = Buffer.from(await image.arrayBuffer());
    const base64 = buffer.toString("base64");

    const openai = new OpenAI({
      apiKey: process.env.OPENAI_API_KEY,
    });

    /**
     * âœ… í•µì‹¬ ì „ëµ
     * - JSON ê°•ì œ
     * - ì½”ë“œë¸”ë¡ ì œê±°
     * - ì‹¤íŒ¨í•´ë„ ìµœì†Œ êµ¬ì¡° ë°˜í™˜
     */
    const completion = await openai.chat.completions.create({
      model: "gpt-4o-mini",
      temperature: 0.2,
      messages: [
        {
          role: "system",
          content: `
ë„ˆëŠ” ë†ë¯¼ì„ ë•ëŠ” í˜„ì¥í˜• ë†ì‘ë¬¼ ì§„ë‹¨ AIë‹¤.

ë°˜ë“œì‹œ **JSONë§Œ** ì¶œë ¥í•˜ë¼.
ì„¤ëª… ë¬¸ì¥, ì½”ë“œë¸”ë¡, ì£¼ì„ ì ˆëŒ€ ê¸ˆì§€.

ì¶œë ¥ í˜•ì‹:
{
  "inferred_crop": "ì‚¬ì§„ ê¸°ë°˜ ì¶”ì • ì‘ë¬¼",
  "observations": ["ëˆˆì— ë³´ì´ëŠ” ì‚¬ì‹¤"],
  "why_uncertain": "ì™œ ì´ ì‚¬ì§„ë§Œìœ¼ë¡œ í™•ì • ë¶ˆê°€í•œì§€",
  "questions": [
    { "id": "q1", "text": "í˜„ì¥ì—ì„œ ë°”ë¡œ í™•ì¸ ê°€ëŠ¥í•œ ì§ˆë¬¸" }
  ]
}

ê·œì¹™:
- ì‘ë¬¼ëª…ì€ ì‚¬ì§„ìœ¼ë¡œ ì¶”ì •
- ë³‘ëª… ë‹¨ì • ê¸ˆì§€
- ì§ˆë¬¸ ìµœëŒ€ 4ê°œ
`
        },
        {
          role: "user",
          content: [
            { type: "text", text: "ì´ ì‚¬ì§„ì„ ì§„ë‹¨í•´ì¤˜" },
            {
              type: "image_url",
              image_url: {
                url: `data:image/jpeg;base64,${base64}`,
              },
            },
          ],
        },
      ],
    });

    const raw = completion.choices[0].message.content || "";

    // ğŸ”’ ì•ˆì „ íŒŒì‹± (```json ì œê±°)
    const cleaned = raw
      .replace(/```json/g, "")
      .replace(/```/g, "")
      .trim();

    let parsed;
    try {
      parsed = JSON.parse(cleaned);
    } catch {
      // â— ì ˆëŒ€ ì‹¤íŒ¨í•˜ì§€ ì•Šë„ë¡ ìµœì†Œ êµ¬ì¡° ë°˜í™˜
      parsed = {
        inferred_crop: "ì‘ë¬¼ ë¯¸ìƒ",
        observations: ["ì‚¬ì§„ì—ì„œ ëšœë ·í•œ ë³‘ì§•ì´ ì¼ë¶€ ê´€ì°°ë©ë‹ˆë‹¤."],
        why_uncertain:
          "ì‚¬ì§„ í•œ ì¥ë§Œìœ¼ë¡œëŠ” ë°œìƒ ì‹œê¸°ì™€ ì§„í–‰ ì†ë„ë¥¼ íŒë‹¨í•˜ê¸° ì–´ë µìŠµë‹ˆë‹¤.",
        questions: [
          { id: "q1", text: "ì´ ì¦ìƒì´ ìµœê·¼ ê°‘ìê¸° ë‚˜íƒ€ë‚¬ìŠµë‹ˆê¹Œ?" },
          { id: "q2", text: "ì£¼ë³€ í¬ê¸°ì—ë„ ê°™ì€ ì¦ìƒì´ ìˆìŠµë‹ˆê¹Œ?" },
        ],
      };
    }

    return NextResponse.json({
      ok: true,
      step: "STEP1",
      ...parsed,
    });
  } catch (err) {
    console.error("STEP1 FINAL ERROR:", err);
    return NextResponse.json(
      { ok: false, error: "STEP1 ì„œë²„ ì˜¤ë¥˜" },
      { status: 500 }
    );
  }
}